<html lang="en">

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width,maximum-scale=1.0,minimum-scale=1.0'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>头像一键生成</title>
  <meta name="keywords" content="在线一键生成国庆红旗风头像网站">
  <meta name="description" content="在线一键生成国庆红旗风头像网站" />
  <style>
    a:link {
      color: #fff;
      text-decoration: none;
    }

    a:visited {
      color: #fff;
    }

    #export {
      display: none;
      margin: 0 auto;
      width: 250px;
      height: 250px;
      margin-top: 50px;
      margin-bottom: 50px
    }

    .operation-btns .o-btn1 {
      background-size: 11.6rem 4.325rem
    }

    .operation-btns .o-btn2 {
      background-size: 11.6rem 3.75rem
    }

    center {
      color: #fff;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="img/strap.min.css">
</head>

<body>
  <div class="wrapper">
    <img src="" alt="" class="img-load" style="width: 9.5rem; position: fixed; top: 0px; left: -9999px;">
    <div class="operation-header">
      <div class="h-title">

      </div>
    </div>
    <div class="operation-box">
      <a class="prev" onClick='changeHat()'></a>
      <div class="operation-img">
        <div class="cropper-content" id="content">
          <canvas class="" id='cvs'></canvas>
        </div>
      </div>
      <a class="next" onClick='changeHat()'></a>
    </div>

    <!-- 生成的头像 -->
    <img id='export' alt='试试截图保存吧' src='' />

    <div class="operation-btns">
      <a class="o-btn1">
        <input class="o-btn1" id='upload' type='file' onchange='viewer()' style='opacity: 0;'>
      </a>
      <a class="o-btn2" onClick='exportFunc()' style="display: none;">
      </a>
    </div>

    <!-- <div class="operation-done">
      <img src="img/act-done-happy.png" class="act-done-happy">
    </div> -->
    <div>
      <center>
        <!-- <a href="#" target="_blank"><img src="img/163296214936538432.png" style="margin-bottom:1.5rem;height:2rem;"></a> -->
        除了手机火狐、谷歌浏览器。部分手机浏览器可能无法长按保存图片，请使用截图保存哦！<br> 更多：微信小程序look云图
      </center>
    </div>
    <!-- <div>
    <center>
      <a href="#" target="_blank"><img src="img/163289263332916427.png" style="margin-bottom:1.5rem;height:2rem;"></a>
    </center>
    </div> -->
  </div>
  <div style='display: none'>
    <img id='img' src='' alt='' />
    <img class='hide' id='hat0' src='img/hat6.png' />
    <img class='hide' id='hat1' src='img/hat0.png' />
    <img class='hide' id='hat2' src='img/hat2.png' />
    <img class='hide' id='hat3' src='img/hat3.png' />
    <img class='hide' id='hat4' src='img/hat1.png' />
    <img class='hide' id='hat5' src='img/hat4.png' />
    <img class='hide' id='hat6' src='img/hat5.png' />
    <img class='hide' id='hat7' src='img/hat7.png' />
    <img class='hide' id='hat8' src='img/hat8.png' />
    <img class='hide' id='hat9' src='img/hat9.png' />
    <img class='hide' id='hat10' src='img/hat10.png' />
    <img class='hide' id='hat11' src='img/hat11.png' />
    <img class='hide' id='hat12' src='img/hat12.png' />
    <img class='hide' id='hat13' src='img/hat13.png' />
    <img class='hide' id='hat14' src='img/hat14.png' />
    <img class='hide' id='hat15' src='img/hat15.png' />
    <img class='hide' id='hat16' src='img/hat16.png' />
    <img class='hide' id='hat17' src='img/hat17.png' />
    <img class='hide' id='hat18' src='img/hat18.png' />
    <img class='hide' id='hat19' src='img/hat19.png' />
    <img class='hide' id='hat20' src='img/hat20.png' />
    <img class='hide' id='hat21' src='img/hat21.png' />
    <img class='hide' id='hat22' src='img/hat22.png' />
    <img class='hide' id='hat23' src='img/hat23.png' />
    <img class='hide' id='hat24' src='img/hat24.png' />
    <img class='hide' id='hat25' src='img/hat25.png' />
    <img class='hide' id='hat26' src='img/hat26.png' />
    <img class='hide' id='hat27' src='img/hat27.png' />
    <img class='hide' id='hat28' src='img/hat28.png' />
    <img class='hide' id='hat29' src='img/hat29.png' />
    <img class='hide' id='hat30' src='img/hat30.png' />
    <img class='hide' id='hat31' src='img/hat31.png' />
    <img class='hide' id='hat32' src='img/hat32.png' />
    <img class='hide' id='hat33' src='img/hat33.png' />
    <img class='hide' id='hat34' src='img/hat34.png' />
    <img class='hide' id='hat35' src='img/hat35.png' />
    <img class='hide' id='hat36' src='img/hat36.png' />
    <img class='hide' id='hat37' src='img/hat37.png' />
    <img class='hide' id='hat38' src='img/hat38.png' />
    <img class='hide' id='hat39' src='img/hat39.png' />
    <img class='hide' id='hat40' src='img/hat40.png' />
    <img class='hide' id='hat41' src='img/hat41.png' />
    <img class='hide' id='hat42' src='img/hat42.png' />
    <img class='hide' id='hat43' src='img/hat43.png' />
    <img class='hide' id='hat44' src='img/hat44.png' />
    <img class='hide' id='hat45' src='img/hat45.png' />
    <img class='hide' id='hat46' src='img/hat46.png' />
    <img class='hide' id='hat47' src='img/hat47.png' />
    <img class='hide' id='hat48' src='img/hat48.png' />
    <img class='hide' id='hat49' src='img/hat49.png' />
    <img class='hide' id='hat50' src='img/hat50.png' />
    <img class='hide' id='hat51' src='img/hat51.png' />
    <img class='hide' id='hat52' src='img/hat52.png' />
    <img class='hide' id='hat53' src='img/hat53.png' />
    <img class='hide' id='hat54' src='img/hat54.png' />
    <img class='hide' id='hat55' src='img/hat55.png' />
    <img class='hide' id='hat56' src='img/hat56.png' />
    <img class='hide' id='hat57' src='img/hat57.png' />
    <img class='hide' id='hat58' src='img/hat58.png' />
    <img class='hide' id='hat59' src='img/hat59.png' />
    <img class='hide' id='hat60' src='img/hat60.png' />
    <img class='hide' id='hat61' src='img/hat61.png' />

  </div>
  <script src="img/fabric.min.js"></script>
  <script>
    var cvs = document.getElementById("cvs");
    var ctx = cvs.getContext("2d");
    var exportImage = document.getElementById("export");
    var img = document.getElementById("img");
    var hat = "hat0";
    var canvasFabric;
    var hatInstance;
    //var screenWidth = window.screen.width < 500 ? window.screen.width : 300;
    var screenWidth = document.getElementById("content").scrollHeight;
    function viewer() {
      var file = document.getElementById("upload").files[0];
      console.log(file);
      var reader = new FileReader;
      if (file) {
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          img.src = reader.result;
          img.onload = function () {
            img2Cvs(img)
          }
        }
      } else {
        img.src = ""
      }
    }
    function img2Cvs(img) {
      cvs.width = img.width;
      cvs.height = img.height;
      cvs.style.display = "block";
      canvasFabric = new fabric.Canvas("cvs", {
        width: screenWidth,
        height: screenWidth,
        backgroundImage: new fabric.Image(img, {
          scaleX: screenWidth / img.width,
          scaleY: screenWidth / img.height
        })
      });
      changeHat();

      document.getElementsByClassName("o-btn1")[0].style.display = "none";
      document.getElementsByClassName("o-btn2")[0].style.display = "block";
      //document.getElementById("tip").style.opacity = 1
    }
    function changeHat() {
      document.getElementById(hat).style.display = "none";
      var hats = document.getElementsByClassName("hide");

      hat = "hat" + (+hat.replace("hat", "") + 1) % hats.length;

      var hatImage = document.getElementById(hat);

      hatImage.style.display = "block";
      if (hatInstance) {
        canvasFabric.remove(hatInstance)
      }
      console.log(hatImage.width);
      console.log(100 / hatImage.width);
      hatInstance = new fabric.Image(hatImage, {
        top: 0,
        left: 0,
        scaleX: screenWidth / hatImage.width,
        scaleY: screenWidth / hatImage.height,
        cornerColor: "#0b3a42",
        cornerStrokeColor: "#fff",
        cornerStyle: "circle",
        transparentCorners: false,
        rotatingPointOffset: 30
      });
      hatInstance.setControlVisible("bl", false);
      hatInstance.setControlVisible("tr", false);
      hatInstance.setControlVisible("tl", false);
      hatInstance.setControlVisible("mr", false);
      hatInstance.setControlVisible("mt", false);
      canvasFabric.add(hatInstance)
    }
    function exportFunc() {
      document.getElementsByClassName("operation-box")[0].style.display = "none";
      document.getElementsByClassName("operation-btns")[0].style.display = "none";

      // document.getElementById("exportBtn").style.display = "none";
      // document.getElementById("tip").innerHTML = "长按图片保存或分享";
      // document.getElementById("change").style.display = "none";

      cvs.style.display = "none";
      exportImage.style.display = "block";

      exportImage.src = canvasFabric.toDataURL({
        type: "image/jpeg",
        width: screenWidth,
        height: screenWidth
      });
      alert('长按图片保存或截图保存');
    }


  </script>
</body>

</html>